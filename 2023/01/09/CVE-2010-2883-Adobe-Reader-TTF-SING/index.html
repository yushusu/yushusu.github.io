<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="https:&#x2F;&#x2F;github.com&#x2F;riusksk&#x2F;vul_war 栈溢出、ROPchainr绕过DEP 参考：https:&#x2F;&#x2F;sp4n9x.github.io&#x2F;2018&#x2F;06&#x2F;01&#x2F;CVE-2010-2883复现与分析&#x2F; PDF文档中包含字体对象，该漏洞就是发生在PDF阅读器对于字体解析过程中，未对字体对象中所包含的SING表的uniqueName字段进行长度校验就执行了strcat，导致了栈">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2010-2883-Adobe Reader TTF SING">
<meta property="og:url" content="http://yushusu.github.io/2023/01/09/CVE-2010-2883-Adobe-Reader-TTF-SING/">
<meta property="og:site_name" content="YUSHUSU">
<meta property="og:description" content="https:&#x2F;&#x2F;github.com&#x2F;riusksk&#x2F;vul_war 栈溢出、ROPchainr绕过DEP 参考：https:&#x2F;&#x2F;sp4n9x.github.io&#x2F;2018&#x2F;06&#x2F;01&#x2F;CVE-2010-2883复现与分析&#x2F; PDF文档中包含字体对象，该漏洞就是发生在PDF阅读器对于字体解析过程中，未对字体对象中所包含的SING表的uniqueName字段进行长度校验就执行了strcat，导致了栈">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://yushusu.github.io/2023/01/09/CVE-2010-2883-Adobe-Reader-TTF-SING/Untitled.png">
<meta property="article:published_time" content="2023-01-09T03:37:33.000Z">
<meta property="article:modified_time" content="2023-07-09T03:41:11.786Z">
<meta property="article:author" content="yushusu">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yushusu.github.io/2023/01/09/CVE-2010-2883-Adobe-Reader-TTF-SING/Untitled.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>CVE-2010-2883-Adobe Reader TTF SING</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/archives/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/yushusu">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2023/06/29/Qiling-framwork-lab/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2022/08/09/GitHub-Security-Lab-CTF-1-SEGV-hunt/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://yushusu.github.io/2023/01/09/CVE-2010-2883-Adobe-Reader-TTF-SING/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://yushusu.github.io/2023/01/09/CVE-2010-2883-Adobe-Reader-TTF-SING/&text=CVE-2010-2883-Adobe Reader TTF SING"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://yushusu.github.io/2023/01/09/CVE-2010-2883-Adobe-Reader-TTF-SING/&title=CVE-2010-2883-Adobe Reader TTF SING"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yushusu.github.io/2023/01/09/CVE-2010-2883-Adobe-Reader-TTF-SING/&is_video=false&description=CVE-2010-2883-Adobe Reader TTF SING"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CVE-2010-2883-Adobe Reader TTF SING&body=Check out this article: http://yushusu.github.io/2023/01/09/CVE-2010-2883-Adobe-Reader-TTF-SING/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://yushusu.github.io/2023/01/09/CVE-2010-2883-Adobe-Reader-TTF-SING/&title=CVE-2010-2883-Adobe Reader TTF SING"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://yushusu.github.io/2023/01/09/CVE-2010-2883-Adobe-Reader-TTF-SING/&title=CVE-2010-2883-Adobe Reader TTF SING"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://yushusu.github.io/2023/01/09/CVE-2010-2883-Adobe-Reader-TTF-SING/&title=CVE-2010-2883-Adobe Reader TTF SING"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://yushusu.github.io/2023/01/09/CVE-2010-2883-Adobe-Reader-TTF-SING/&title=CVE-2010-2883-Adobe Reader TTF SING"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://yushusu.github.io/2023/01/09/CVE-2010-2883-Adobe-Reader-TTF-SING/&name=CVE-2010-2883-Adobe Reader TTF SING&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://yushusu.github.io/2023/01/09/CVE-2010-2883-Adobe-Reader-TTF-SING/&t=CVE-2010-2883-Adobe Reader TTF SING"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87TEB%E5%AE%9E%E7%8E%B0shellcode%E4%BD%8D%E7%BD%AE"><span class="toc-number">1.</span> <span class="toc-text">通过TEB实现shellcode位置</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        CVE-2010-2883-Adobe Reader TTF SING
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">yushusu</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-01-09T03:37:33.000Z" class="dt-published" itemprop="datePublished">2023-01-09</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p><a target="_blank" rel="noopener" href="https://github.com/riusksk/vul_war">https://github.com/riusksk/vul_war</a></p>
<p>栈溢出、ROPchainr绕过DEP</p>
<p>参考：<a target="_blank" rel="noopener" href="https://sp4n9x.github.io/2018/06/01/CVE-2010-2883%E5%A4%8D%E7%8E%B0%E4%B8%8E%E5%88%86%E6%9E%90/">https://sp4n9x.github.io/2018/06/01/CVE-2010-2883复现与分析/</a></p>
<p>PDF文档中包含<code>字体对象</code>，该漏洞就是发生在PDF阅读器对于字体解析过程中，未对字体对象中所包含的<code>SING表</code>的<code>uniqueName字段</code>进行长度校验就执行了strcat，导致了<code>栈溢出</code>漏洞的发生。下面是我通过<code>PdfStreamDumper</code>读出来的一些PDF的内容：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/Type /Font         <span class="comment">//字体对象</span></span><br><span class="line">    /Subtype /TrueType  <span class="comment">//字体类型是TrueType</span></span><br><span class="line">    /Name /F1</span><br><span class="line">    /BaseFont /Cinema   <span class="comment">//基于Cinema字体</span></span><br><span class="line">    /Widths []</span><br><span class="line">    /FontDescriptor <span class="number">9</span> <span class="number">0</span> R   <span class="comment">//对象9是字体描述对象</span></span><br><span class="line">    /Encoding /MacRomanEncoding     <span class="comment">//字符编码采用MacRoman</span></span><br></pre></td></tr></table></figure>

<img src="/2023/01/09/CVE-2010-2883-Adobe-Reader-TTF-SING/Untitled.png" class title="Untitled">

<p>TrueType字体用machintosh的轮廓字体资源的格式编码，有一个唯一的标记名”sfnt”。windows没有macintosh的位图字体资源格式，</p>
<p>字体目录包含了字体格式的版本号和几个表，每个表都有一个TableEntry结构项，TableEntry结构包含了资源标记、校验和、偏移量和每个表的大小。下面是TrueType字体目录的c语言定义：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//也就是SING表上的数据</span></span><br><span class="line"><span class="keyword">typedef</span> struct_SING</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> tag[<span class="number">4</span>];        <span class="comment">//标记：&quot;SING&quot;</span></span><br><span class="line">    ULONG checkSum;     <span class="comment">//校验和：&quot;0xD9BCC8B5&quot;</span></span><br><span class="line">    ULONG offset;       <span class="comment">//表偏移：&quot;0x0000011c&quot;</span></span><br><span class="line">    ULONG length;       <span class="comment">//数据长度：&quot;0x00001DDF&quot;</span></span><br><span class="line">&#125;TableEntry;</span><br><span class="line"><span class="comment">//TrueType字体中的所有数据都使用big-endian编码，最高位字节在最前面（因为TrueType字体最初是由apple公司定义的，而apple公司的os运行在motorola的cpu上）。</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如果一TrueType字体以00 01 00 00 ,00 17开头，我们就可以知道它的格式是轮廓字体资源（”sfnt”）版本1.0的格式，有23个表。</p>


<p>ida分析CoolType.dll找到SING字符串，交叉引用找到ParseSING的函数如下</p>




<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">text:<span class="number">0803</span>DCF9 ParseSING       proc near               ; CODE XREF: sub_803A3B2+<span class="number">55</span>↑p</span><br><span class="line">.text:<span class="number">0803</span>DCF9                                         ; sub_803DFF4+<span class="number">28</span>↓p ...</span><br><span class="line">.text:<span class="number">0803</span>DCF9</span><br><span class="line">.text:<span class="number">0803</span>DCF9 var_160         = byte ptr <span class="number">-160</span>h</span><br><span class="line">.text:<span class="number">0803</span>DCF9 var_140         = dword ptr <span class="number">-140</span>h</span><br><span class="line">.text:<span class="number">0803</span>DCF9 var_138         = dword ptr <span class="number">-138</span>h</span><br><span class="line">.text:<span class="number">0803</span>DCF9 var_134         = dword ptr <span class="number">-134</span>h</span><br><span class="line">.text:<span class="number">0803</span>DCF9 var_130         = dword ptr <span class="number">-130</span>h</span><br><span class="line">.text:<span class="number">0803</span>DCF9 var_12C         = dword ptr <span class="number">-12</span>Ch</span><br><span class="line">.text:<span class="number">0803</span>DCF9 var_128         = dword ptr <span class="number">-128</span>h</span><br><span class="line">.text:<span class="number">0803</span>DCF9 var_124         = dword ptr <span class="number">-124</span>h</span><br><span class="line">.text:<span class="number">0803</span>DCF9 var_120         = dword ptr <span class="number">-120</span>h</span><br><span class="line">.text:<span class="number">0803</span>DCF9 var_119         = byte ptr <span class="number">-119</span>h</span><br><span class="line">.text:<span class="number">0803</span>DCF9 var_114         = dword ptr <span class="number">-114</span>h</span><br><span class="line">.text:<span class="number">0803</span>DCF9 var_10C         = dword ptr <span class="number">-10</span>Ch</span><br><span class="line">.text:<span class="number">0803</span>DCF9 Destination_uniquename= byte ptr <span class="number">-108</span>h</span><br><span class="line">.text:<span class="number">0803</span>DCF9 var_4           = dword ptr <span class="number">-4</span></span><br><span class="line">.text:<span class="number">0803</span>DCF9 arg_0           = dword ptr  <span class="number">8</span></span><br><span class="line">.text:<span class="number">0803</span>DCF9 arg_4           = dword ptr  <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">0803</span>DCF9 arg_8           = dword ptr  <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0803</span>DCF9 arg_C           = dword ptr  <span class="number">14</span>h</span><br><span class="line">.text:<span class="number">0803</span>DCF9</span><br><span class="line">.text:<span class="number">0803</span>DCF9 ; FUNCTION CHUNK AT .text:<span class="number">0808</span>D418 SIZE <span class="number">0000000</span>E BYTES</span><br><span class="line">.text:<span class="number">0803</span>DCF9 ; FUNCTION CHUNK AT .text:<span class="number">08184</span>A24 SIZE <span class="number">00000058</span> BYTES</span><br><span class="line">.text:<span class="number">0803</span>DCF9</span><br><span class="line">.text:<span class="number">0803</span>DCF9 ; __unwind &#123; <span class="comment">// loc_8184A54</span></span><br><span class="line">.text:<span class="number">0803</span>DCF9                 push    ebp</span><br><span class="line">.text:<span class="number">0803</span>DCFA                 sub     esp, <span class="number">104</span>h</span><br><span class="line">.text:<span class="number">0803</span>DD00                 lea     ebp, [esp<span class="number">-4</span>]    ; esp<span class="number">-4</span>赋给ebp,而不是esp<span class="number">-4</span>处的值赋给ebp,后面strcat会把执行结果保存在以ebp为起始地址的栈空间中</span><br><span class="line">.text:<span class="number">0803</span>DD04                 mov     eax, ___security_cookie</span><br><span class="line">.text:<span class="number">0803</span>DD09                 xor     eax, ebp</span><br><span class="line">.text:<span class="number">0803</span>DD0B                 mov     [ebp+<span class="number">108</span>h+var_4], eax ; 将和ebp异或完的security_cookie存到栈上父函数ebp之前的<span class="number">4</span>字节中</span><br><span class="line">.text:<span class="number">0803</span>DD11                 push    <span class="number">4</span>Ch             ; __EH_prolog3_catch函数中分配栈空间的大小</span><br><span class="line">.text:<span class="number">0803</span>DD13                 mov     eax, offset loc_8184A54 ; 调用__security_check_cookie函数的代码段起始地址</span><br><span class="line">.text:<span class="number">0803</span>DD18                 call    __EH_prolog3_catch ; 向栈上写入SEH结构</span><br><span class="line">.text:<span class="number">0803</span>DD1D                 mov     eax, [ebp+<span class="number">108</span>h+arg_C]</span><br><span class="line">.text:<span class="number">0803</span>DD23                 mov     edi, [ebp+<span class="number">108</span>h+arg_0]</span><br><span class="line">.text:<span class="number">0803</span>DD29                 mov     ebx, [ebp+<span class="number">108</span>h+arg_4]</span><br><span class="line">.text:<span class="number">0803</span>DD2F                 mov     [ebp+<span class="number">108</span>h+var_130], edi</span><br><span class="line">.text:<span class="number">0803</span>DD32                 mov     [ebp+<span class="number">108</span>h+var_138], eax</span><br><span class="line">.text:<span class="number">0803</span>DD35                 call    sub_804172C</span><br><span class="line">.text:<span class="number">0803</span>DD3A                 xor     esi, esi</span><br><span class="line">.text:<span class="number">0803</span>DD3C                 cmp     dword ptr [edi+<span class="number">8</span>], <span class="number">3</span></span><br><span class="line">.text:<span class="number">0803</span>DD40 ;   try &#123;</span><br><span class="line">.text:<span class="number">0803</span>DD40                 mov     [ebp+<span class="number">108</span>h+var_10C], esi</span><br><span class="line">.text:<span class="number">0803</span>DD43                 jz      loc_803DF00</span><br><span class="line">.text:<span class="number">0803</span>DD49                 mov     [ebp+<span class="number">108</span>h+var_124], esi</span><br><span class="line">.text:<span class="number">0803</span>DD4C                 mov     [ebp+<span class="number">108</span>h+var_120], esi</span><br><span class="line">.text:<span class="number">0803</span>DD4F                 cmp     dword ptr [edi+<span class="number">0</span>Ch], <span class="number">1</span></span><br><span class="line">.text:<span class="number">0803</span>DD4F ;   &#125; <span class="comment">// starts at 803DD40</span></span><br><span class="line">.text:<span class="number">0803</span>DD53 ;   try &#123;</span><br><span class="line">.text:<span class="number">0803</span>DD53                 mov     byte ptr [ebp+<span class="number">108</span>h+var_10C], <span class="number">1</span></span><br><span class="line">.text:<span class="number">0803</span>DD57                 jnz     loc_803DEA9</span><br><span class="line">.text:<span class="number">0803</span>DD5D                 push    offset aName    ; <span class="string">&quot;name&quot;</span></span><br><span class="line">.text:<span class="number">0803</span>DD62                 push    edi             ; <span class="type">int</span></span><br><span class="line">.text:<span class="number">0803</span>DD63                 lea     ecx, [ebp+<span class="number">108</span>h+var_124]</span><br><span class="line">.text:<span class="number">0803</span>DD66                 mov     [ebp+<span class="number">108</span>h+var_119], <span class="number">0</span></span><br><span class="line">.text:<span class="number">0803</span>DD6A                 call    sub_80217D7</span><br><span class="line">.text:<span class="number">0803</span>DD6F                 cmp     [ebp+<span class="number">108</span>h+var_124], esi</span><br><span class="line">.text:<span class="number">0803</span>DD72                 jnz     <span class="type">short</span> loc_803DDDD</span><br><span class="line">.text:<span class="number">0803</span>DD74                 push    offset aSing    ; <span class="string">&quot;SING&quot;</span></span><br><span class="line">.text:<span class="number">0803</span>DD79                 push    edi             ; <span class="type">int</span></span><br><span class="line">.text:<span class="number">0803</span>DD7A                 lea     ecx, [ebp+<span class="number">108</span>h+var_12C] ; ecx为字体对象,thiscall,ecx传参,指向SING表入口</span><br><span class="line">.text:<span class="number">0803</span>DD7D                 call    sub_8021B06     ; 处理sing表</span><br><span class="line">.text:<span class="number">0803</span>DD82                 mov     eax, [ebp+<span class="number">108</span>h+var_12C] ; sing表 = shellcode</span><br><span class="line">.text:<span class="number">0803</span>DD85                 cmp     eax, esi        ; 比较是否为空</span><br><span class="line">.text:<span class="number">0803</span>DD85 ;   &#125; <span class="comment">// starts at 803DD53</span></span><br><span class="line">.text:<span class="number">0803</span>DD87 ;   try &#123;</span><br><span class="line">.text:<span class="number">0803</span>DD87                 mov     byte ptr [ebp+<span class="number">108</span>h+var_10C], <span class="number">2</span></span><br><span class="line">.text:<span class="number">0803</span>DD8B                 jz      <span class="type">short</span> loc_803DDC4 ; 不跳转</span><br><span class="line">.text:<span class="number">0803</span>DD8D                 mov     ecx, [eax]      ; 字体资源版本号，<span class="number">1.0</span>版本为<span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">.text:<span class="number">0803</span>DD8F                 and     ecx, <span class="number">0</span>FFFFh</span><br><span class="line">.text:<span class="number">0803</span>DD95                 jz      <span class="type">short</span> loc_803DD9F ; 跳这里</span><br><span class="line">.text:<span class="number">0803</span>DD97                 cmp     ecx, <span class="number">100</span>h</span><br><span class="line">.text:<span class="number">0803</span>DD9D                 jnz     <span class="type">short</span> loc_803DDC0</span><br><span class="line">.text:<span class="number">0803</span>DD9F</span><br><span class="line">.text:<span class="number">0803</span>DD9F loc_803DD9F:                            ; CODE XREF: ParseSING+<span class="number">9</span>C↑j</span><br><span class="line">.text:<span class="number">0803</span>DD9F                 add     eax, <span class="number">10</span>h        ; 相对SING表入口处<span class="number">0x10</span>找到uniqueName</span><br><span class="line">.text:<span class="number">0803</span>DDA2                 push    eax             ; Source</span><br><span class="line">.text:<span class="number">0803</span>DDA3                 lea     eax, [ebp+<span class="number">108</span>h+Destination_uniquename] ; 这里将ebp的值作为目的地址，也就是前面所分配的缓冲区的起始地址</span><br><span class="line">.text:<span class="number">0803</span>DDA6                 push    eax             ; Destination</span><br><span class="line">.text:<span class="number">0803</span>DDA7                 mov     [ebp+<span class="number">108</span>h+Destination_uniquename], <span class="number">0</span> ; 将目标字符串赋值为<span class="literal">NULL</span>,空字符串</span><br><span class="line">.text:<span class="number">0803</span>DDAB                 call    strcat          ; leak</span><br><span class="line">.text:<span class="number">0803</span>DDB0                 pop     ecx</span><br><span class="line">.text:<span class="number">0803</span>DDB1                 pop     ecx</span><br><span class="line">.text:<span class="number">0803</span>DDB2                 lea     eax, [ebp+<span class="number">108</span>h+Destination_uniquename]</span><br><span class="line">.text:<span class="number">0803</span>DDB5                 push    eax</span><br><span class="line">.text:<span class="number">0803</span>DDB6                 mov     ecx, ebx</span><br><span class="line">.text:<span class="number">0803</span>DDB8                 call    sub_8001243</span><br><span class="line">.text:<span class="number">0803</span>DDBD                 mov     eax, [ebp+<span class="number">108</span>h+var_12C]</span><br><span class="line">.text:<span class="number">0803</span>DDC0</span><br></pre></td></tr></table></figure>

<p><strong>动调观察并回溯：</strong></p>


<p>在<code>0x0803DD9F</code>下断点,运行程序，可以看到复制到栈上的<code>数据长度</code>：0x0012E718 - 0x0012E4D8 &#x3D; 0x240</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ecx=ebx=0x0012E608,对象(0x0012E608)的指针,第一个成员变量原来是0,可以直接跳过sub_8001243()的一段代码,但是我们构造的uniqueName不能将这里构造为0x0,会造成截断,其内容+0x1c必须为一个可访问的地址,使得程序可以顺利执行通过第一个成员变量为0时跳过的那段代码。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>strcat执行之后会将uniquename起始部分复制到0x0012E4D8直到NULL字符</p>
<p>DEP（Data Execution Prevention）：防止一些内存位置执行代码的一种保护机制，特别是堆栈，因此在windows中利用栈返回技术攻击溢出的方法已不再适用了。</p>
<p>ROP（Return Oriented Programming）:连续调用程序代码本身的内存地址，以逐步地创建一连串欲执行的指令序列。</p>
<p><strong>利用过程：</strong></p>
<p>我们从<code>metasploit</code>的漏洞利用代码中可以知道<code>SING表的数据</code>主要是构造了一个**<code>ROP链</code><strong>,用于<code>控制EIP</code>最终跳转到<code>堆喷</code>的真正的用于<code>绕过DEP</code>的<code>ROP Chain</code>处。从代码注释中可知,</strong><code>第一个ROPgadget</code><strong>位于icucnv36.dll中的<code>0x4A80CB38</code>处,</strong><code>第二个ROPgadget</code>**位于icucnv36.dll中的<code>0x4A82A714</code>处。这部分后面会介绍,为什么选用这两个地址呢？因为在<code>Adobe Reader</code>的<code>各个版本</code>上，这个dll的这两处地址是<code>始终不变</code>的，从而保证了<code>exploit</code>对于各版本的<code>兼容性</code>和<code>稳定性</code>。</p>
<p><a target="_blank" rel="noopener" href="https://www.notion.so/3d37050201a34b2ebedbab9a12696f2a?pvs=21">堆喷</a></p>
<p><strong>触发过程：</strong></p>


<p><code>样本</code>构造的<code>SING表</code>的<code>“uniqueName”字段</code>将栈上<code>对象(0x0012E6B0)</code>的一个<code>函数指针</code>类型的<code>成员变量(0x0012E6D0)</code>覆盖为了<code>ROPgadget(0x4A80CB38)</code>的地址。而触发点为<code>StreamHandler类</code>的<code>虚函数sub_808B116()</code>中地址<code>0x0808B308</code>处的调用指令<code>call dword ptr [eax]</code>,这条调用指令将<code>对象(0x0012E6B0)</code>中的<code>函数指针(0x0012E6D0)的值</code>作为调用地址,从而获得程序执行流的劫持。这个<code>函数指针的地址</code>又存储在<code>对象(0x0012E718)</code>中的一个<code>指针类型</code>的<code>成员变量(0x0012E754)</code>中。<code>虚函数sub_808B116()</code>通过传入的<code>参数对象(0x0012E718)</code>的指针,找到<code>对象(0x0012E6B0)</code>中的<code>函数指针(0x0012E6D0)</code>,进行函数调用,从而获得程序执行流的劫持。</p>


<p><strong>样本中SING表数据“0x4A8A08C6”的作用：</strong></p>
<p><code>0x4A8A08C6</code>是一个<code>地址值</code>,<code>0x4A8A08C6+0x1C=0x4A8A08E2</code>应具有<code>可读可写</code>权限。因为,在通过<code>strcat()</code>将<code>SING表数据</code>复制到<code>栈</code>上之后,以及获得<code>程序执行流</code>的劫持之前,会对<code>此地址</code>进行<code>读写</code>,所以构造的样本中<code>此处的地址+0x1C</code>必须具有<code>可读可写</code>权限,否则会<code>触发异常</code>,通过<code>SEH链</code>进入异常处理,就无法获得程序执行流的劫持。</p>
<p><strong>分析ROPgadget1:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">icucnv36.4A80CB38    81C5 94070000   add ebp,0x794 ; ebp=0x0012DD48+0x794=0x0012E4DC</span><br><span class="line">icucnv36.4A80CB3E    C9              leave         ; 如下</span><br><span class="line">icucnv36.4A80CB3F    C3              retn</span><br><span class="line"></span><br><span class="line">leave:</span><br><span class="line">mov esp,ebp ; esp=ebp=0x0012E4DC</span><br><span class="line">pop ebp     ; esp=esp+0x4=0x0012E4E0 -&gt; ROPgadget2</span><br></pre></td></tr></table></figure>

<p><strong>分析ROPgadget2:</strong></p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">icucnv36<span class="number">.4</span>A82A712    FF50 <span class="number">5</span>C         call dword ptr ds:[eax+<span class="number">0x5C</span>]</span><br><span class="line">icucnv36<span class="number">.4</span>A82A715    C3              retn</span><br><span class="line"></span><br><span class="line">icucnv36<span class="number">.4</span>A82A714    <span class="number">5</span>C              pop esp ; esp=<span class="number">0x0C0C0C0C</span>                       </span><br><span class="line">icucnv36<span class="number">.4</span>A82A715    C3              retn</span><br></pre></td></tr></table></figure>

<p><code>DEP</code>(Data Execution Prevention),即<code>数据执行保护</code>。开启后,<code>堆栈</code>是不具有<code>执行权限</code>的,所以不能直接在<code>缓冲区</code>中填入<code>Payload</code>。而<code>ROP</code>(Return-Oriented Programming),<code>返回导向编程</code>,则是通过程序中<code>已存在</code>的多段小的<code>代码片段(ROPgadget)</code>来控制程序执行流的。缓冲区中填入的只是<code>代码片段的首地址</code>。样本中使用了<code>两段ROPgadget</code>代码片段用于<code>绕过DEP</code>。</p>
<h3 id="通过TEB实现shellcode位置"><a href="#通过TEB实现shellcode位置" class="headerlink" title="通过TEB实现shellcode位置"></a>通过TEB实现shellcode位置</h3><p>寻找模块装载地址：<a target="_blank" rel="noopener" href="https://4hou.win/wordpress/?p=8945">https://4hou.win/wordpress/?p=8945</a></p>
<p>当<code>exe</code>文件载入内存时，在NT内核系统中<code>fs:[0]</code>指向了<code>TEB</code>结构，<code>TEB(Thread Environment Block)</code>位于用户地址空间，进程中的每个线程都有自己的一个TEB，然后找到PEB，然后找到PEB_LDR_DATA，然后找到LIST_ENRTY然后找到_LDR_DATA_TABLE_ENTRY就可以找到dll</p>


<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">MOV EAX, FS:[<span class="number">30</span>] <span class="comment">// EAX = PEB基址 </span></span><br><span class="line"></span><br><span class="line">MOV EAX, [EAX+C] <span class="comment">//EAX = PEB_LDR_DATA结构指针 </span></span><br><span class="line"></span><br><span class="line">MOV ESI, [EAX+<span class="number">14</span>] <span class="comment">// ESI = 第一个_LDR_DATA_TABLE_ENTRY</span></span><br><span class="line"></span><br><span class="line">MOV ESI, [ESI] <span class="comment">// ESI = 第二个_LDR_DATA_TABLE_ENTRY</span></span><br><span class="line"></span><br><span class="line">MOV ESI, [ESI] <span class="comment">// ESI = 第三个_LDR_DATA_TABLE_ENTRY</span></span><br><span class="line"></span><br><span class="line">MOV EBX, [ESI+<span class="number">10</span>] <span class="comment">// EBX = kernel32.dll基地址</span></span><br></pre></td></tr></table></figure>

<p>有了<code>kernel32.dll</code>的基地址，我们就可以根据<code>PE</code>文件的结构找到<code>GetProcAddress</code>的地址，然后可以随意得到需要的函数地址，为之后的shellcode编写提供了便利，这种通用性代码的发明使得shellcode能够在不同的系统版本上稳定的工作。</p>
<p><strong>对于lodsb指令：</strong></p>
<p>LODS 从串取指令</p>
<p>LODS SRC</p>
<p>LODSB &#x2F;&#x2F;从字节串取 AL&#x3D;(SI)</p>
<p>LODSW &#x2F;&#x2F;从字串取 AX&#x3D; (SI±1) (SI)</p>
<p>执行操作：把由SI指定的数据段中字节或字单元的内容送入AL或AX中,并根据DF值及数据类型修改SI的内容.</p>
<p>1.在执行该指令之前,要取的数据必须在存储器中预先定义(用DB或DW),必须预置SI的初值.</p>
<p>2.源串允许使用段超越前缀来改变数据存储的段区.</p>
<p>正确格式应该是lodsb&#x2F;lodsw&#x2F;lodsd（d后缀在32位汇编中使用）。</p>
<p>源操作数是默认为SI&#x2F;ESI。且不能使用别的寄存器。</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/archives/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a target="_blank" rel="noopener" href="http://github.com/yushusu">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87TEB%E5%AE%9E%E7%8E%B0shellcode%E4%BD%8D%E7%BD%AE"><span class="toc-number">1.</span> <span class="toc-text">通过TEB实现shellcode位置</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://yushusu.github.io/2023/01/09/CVE-2010-2883-Adobe-Reader-TTF-SING/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://yushusu.github.io/2023/01/09/CVE-2010-2883-Adobe-Reader-TTF-SING/&text=CVE-2010-2883-Adobe Reader TTF SING"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://yushusu.github.io/2023/01/09/CVE-2010-2883-Adobe-Reader-TTF-SING/&title=CVE-2010-2883-Adobe Reader TTF SING"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yushusu.github.io/2023/01/09/CVE-2010-2883-Adobe-Reader-TTF-SING/&is_video=false&description=CVE-2010-2883-Adobe Reader TTF SING"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CVE-2010-2883-Adobe Reader TTF SING&body=Check out this article: http://yushusu.github.io/2023/01/09/CVE-2010-2883-Adobe-Reader-TTF-SING/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://yushusu.github.io/2023/01/09/CVE-2010-2883-Adobe-Reader-TTF-SING/&title=CVE-2010-2883-Adobe Reader TTF SING"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://yushusu.github.io/2023/01/09/CVE-2010-2883-Adobe-Reader-TTF-SING/&title=CVE-2010-2883-Adobe Reader TTF SING"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://yushusu.github.io/2023/01/09/CVE-2010-2883-Adobe-Reader-TTF-SING/&title=CVE-2010-2883-Adobe Reader TTF SING"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://yushusu.github.io/2023/01/09/CVE-2010-2883-Adobe-Reader-TTF-SING/&title=CVE-2010-2883-Adobe Reader TTF SING"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://yushusu.github.io/2023/01/09/CVE-2010-2883-Adobe-Reader-TTF-SING/&name=CVE-2010-2883-Adobe Reader TTF SING&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://yushusu.github.io/2023/01/09/CVE-2010-2883-Adobe-Reader-TTF-SING/&t=CVE-2010-2883-Adobe Reader TTF SING"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2023
    yushusu
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/archives/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/yushusu">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
